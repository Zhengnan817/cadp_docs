<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>8 Data Pipelines | Getting Started with the Climate Adaptation Data Platform</title>
  <meta name="description" content="8 Data Pipelines | Getting Started with the Climate Adaptation Data Platform" />
  <meta name="generator" content="bookdown 0.39 and GitBook 2.6.7" />

  <meta property="og:title" content="8 Data Pipelines | Getting Started with the Climate Adaptation Data Platform" />
  <meta property="og:type" content="book" />
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="8 Data Pipelines | Getting Started with the Climate Adaptation Data Platform" />
  
  
  

<meta name="author" content="Brian Lee Yung Rowe" />


<meta name="date" content="2024-06-01" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="plugins.html"/>
<link rel="next" href="technical-details.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script>
<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>



<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Preface</a></li>
<li class="chapter" data-level="2" data-path="overview.html"><a href="overview.html"><i class="fa fa-check"></i><b>2</b> Overview</a></li>
<li class="chapter" data-level="3" data-path="use-cases.html"><a href="use-cases.html"><i class="fa fa-check"></i><b>3</b> Use Cases</a>
<ul>
<li class="chapter" data-level="3.1" data-path="use-cases.html"><a href="use-cases.html#public-health"><i class="fa fa-check"></i><b>3.1</b> Public health</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="use-cases.html"><a href="use-cases.html#early-warning-systems"><i class="fa fa-check"></i><b>3.1.1</b> Early warning systems</a></li>
<li class="chapter" data-level="3.1.2" data-path="use-cases.html"><a href="use-cases.html#heat-risk"><i class="fa fa-check"></i><b>3.1.2</b> Heat risk</a></li>
<li class="chapter" data-level="3.1.3" data-path="use-cases.html"><a href="use-cases.html#mosquito-borne-infectious-disease"><i class="fa fa-check"></i><b>3.1.3</b> Mosquito-borne infectious disease</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="use-cases.html"><a href="use-cases.html#precision-agriculture"><i class="fa fa-check"></i><b>3.2</b> Precision agriculture</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="use-cases.html"><a href="use-cases.html#dry-soil-forecasting"><i class="fa fa-check"></i><b>3.2.1</b> Dry soil forecasting</a></li>
<li class="chapter" data-level="3.2.2" data-path="use-cases.html"><a href="use-cases.html#watering-schedules"><i class="fa fa-check"></i><b>3.2.2</b> Watering schedules</a></li>
<li class="chapter" data-level="3.2.3" data-path="use-cases.html"><a href="use-cases.html#crop-development"><i class="fa fa-check"></i><b>3.2.3</b> Crop development</a></li>
<li class="chapter" data-level="3.2.4" data-path="use-cases.html"><a href="use-cases.html#risk-protocol-for-dry-soil"><i class="fa fa-check"></i><b>3.2.4</b> Risk protocol for dry soil</a></li>
<li class="chapter" data-level="3.2.5" data-path="use-cases.html"><a href="use-cases.html#irrigation-control"><i class="fa fa-check"></i><b>3.2.5</b> Irrigation control</a></li>
<li class="chapter" data-level="3.2.6" data-path="use-cases.html"><a href="use-cases.html#freeze-warnings"><i class="fa fa-check"></i><b>3.2.6</b> Freeze warnings</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="use-cases.html"><a href="use-cases.html#hotter-times"><i class="fa fa-check"></i><b>3.3</b> Hotter Times</a></li>
<li class="chapter" data-level="3.4" data-path="use-cases.html"><a href="use-cases.html#mobile-app"><i class="fa fa-check"></i><b>3.4</b> Mobile app</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="physical-infrastructure.html"><a href="physical-infrastructure.html"><i class="fa fa-check"></i><b>4</b> Physical Infrastructure</a></li>
<li class="chapter" data-level="5" data-path="device-operation.html"><a href="device-operation.html"><i class="fa fa-check"></i><b>5</b> Device Operation</a></li>
<li class="chapter" data-level="6" data-path="cadp-architecture.html"><a href="cadp-architecture.html"><i class="fa fa-check"></i><b>6</b> CADP Architecture</a>
<ul>
<li class="chapter" data-level="6.1" data-path="cadp-architecture.html"><a href="cadp-architecture.html#design-principles"><i class="fa fa-check"></i><b>6.1</b> Design principles</a></li>
<li class="chapter" data-level="6.2" data-path="cadp-architecture.html"><a href="cadp-architecture.html#database"><i class="fa fa-check"></i><b>6.2</b> Database</a></li>
<li class="chapter" data-level="6.3" data-path="cadp-architecture.html"><a href="cadp-architecture.html#sensor-data-ingestion"><i class="fa fa-check"></i><b>6.3</b> Sensor data ingestion</a>
<ul>
<li class="chapter" data-level="6.3.1" data-path="cadp-architecture.html"><a href="cadp-architecture.html#raw-sensor-data"><i class="fa fa-check"></i><b>6.3.1</b> Raw sensor data</a></li>
<li class="chapter" data-level="6.3.2" data-path="cadp-architecture.html"><a href="cadp-architecture.html#data-issues"><i class="fa fa-check"></i><b>6.3.2</b> Data issues</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="cadp-architecture.html"><a href="cadp-architecture.html#weather-forecasting"><i class="fa fa-check"></i><b>6.4</b> Weather forecasting</a>
<ul>
<li class="chapter" data-level="6.4.1" data-path="cadp-architecture.html"><a href="cadp-architecture.html#ecmwf-forecasts"><i class="fa fa-check"></i><b>6.4.1</b> ECMWF forecasts</a></li>
</ul></li>
<li class="chapter" data-level="6.5" data-path="cadp-architecture.html"><a href="cadp-architecture.html#early-warning-system"><i class="fa fa-check"></i><b>6.5</b> Early warning system</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="plugins.html"><a href="plugins.html"><i class="fa fa-check"></i><b>7</b> Plugins</a>
<ul>
<li class="chapter" data-level="7.1" data-path="plugins.html"><a href="plugins.html#forecasting-plugins"><i class="fa fa-check"></i><b>7.1</b> Forecasting plugins</a></li>
<li class="chapter" data-level="7.2" data-path="plugins.html"><a href="plugins.html#risk-protocols"><i class="fa fa-check"></i><b>7.2</b> Risk protocols</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="data-pipelines.html"><a href="data-pipelines.html"><i class="fa fa-check"></i><b>8</b> Data Pipelines</a>
<ul>
<li class="chapter" data-level="8.1" data-path="data-pipelines.html"><a href="data-pipelines.html#ecmwf-baseline-forecasts"><i class="fa fa-check"></i><b>8.1</b> ECMWF baseline forecasts</a>
<ul>
<li class="chapter" data-level="8.1.1" data-path="data-pipelines.html"><a href="data-pipelines.html#data-extraction"><i class="fa fa-check"></i><b>8.1.1</b> Data extraction</a></li>
<li class="chapter" data-level="8.1.2" data-path="data-pipelines.html"><a href="data-pipelines.html#data-normalization"><i class="fa fa-check"></i><b>8.1.2</b> Data normalization</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="data-pipelines.html"><a href="data-pipelines.html#sensor-normalization"><i class="fa fa-check"></i><b>8.2</b> Sensor normalization</a></li>
<li class="chapter" data-level="8.3" data-path="data-pipelines.html"><a href="data-pipelines.html#temperature-forecast"><i class="fa fa-check"></i><b>8.3</b> Temperature forecast</a></li>
<li class="chapter" data-level="8.4" data-path="data-pipelines.html"><a href="data-pipelines.html#precipitation-forecast"><i class="fa fa-check"></i><b>8.4</b> Precipitation forecast</a></li>
<li class="chapter" data-level="8.5" data-path="data-pipelines.html"><a href="data-pipelines.html#disk-space-monitoring"><i class="fa fa-check"></i><b>8.5</b> Disk space monitoring</a></li>
<li class="chapter" data-level="8.6" data-path="data-pipelines.html"><a href="data-pipelines.html#battery-level-monitoring"><i class="fa fa-check"></i><b>8.6</b> Battery level monitoring</a></li>
<li class="chapter" data-level="8.7" data-path="data-pipelines.html"><a href="data-pipelines.html#location-change"><i class="fa fa-check"></i><b>8.7</b> Location change</a></li>
<li class="chapter" data-level="8.8" data-path="data-pipelines.html"><a href="data-pipelines.html#device-availability"><i class="fa fa-check"></i><b>8.8</b> Device availability</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="technical-details.html"><a href="technical-details.html"><i class="fa fa-check"></i><b>9</b> Technical Details</a>
<ul>
<li class="chapter" data-level="9.1" data-path="technical-details.html"><a href="technical-details.html#system-requirements"><i class="fa fa-check"></i><b>9.1</b> System requirements</a></li>
<li class="chapter" data-level="9.2" data-path="technical-details.html"><a href="technical-details.html#project-structure"><i class="fa fa-check"></i><b>9.2</b> Project structure</a>
<ul>
<li class="chapter" data-level="9.2.1" data-path="technical-details.html"><a href="technical-details.html#ecm-etl"><i class="fa fa-check"></i><b>9.2.1</b> ECM ETL</a></li>
</ul></li>
<li class="chapter" data-level="9.3" data-path="technical-details.html"><a href="technical-details.html#sensor-api"><i class="fa fa-check"></i><b>9.3</b> Sensor API</a></li>
<li class="chapter" data-level="9.4" data-path="technical-details.html"><a href="technical-details.html#sensor-etl"><i class="fa fa-check"></i><b>9.4</b> Sensor ETL</a></li>
<li class="chapter" data-level="9.5" data-path="technical-details.html"><a href="technical-details.html#local-data-cache"><i class="fa fa-check"></i><b>9.5</b> Local data cache</a></li>
<li class="chapter" data-level="9.6" data-path="technical-details.html"><a href="technical-details.html#initialization"><i class="fa fa-check"></i><b>9.6</b> Initialization</a></li>
<li class="chapter" data-level="9.7" data-path="technical-details.html"><a href="technical-details.html#building-images"><i class="fa fa-check"></i><b>9.7</b> Building images</a></li>
<li class="chapter" data-level="9.8" data-path="technical-details.html"><a href="technical-details.html#running-a-container"><i class="fa fa-check"></i><b>9.8</b> Running a container</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="appendix.html"><a href="appendix.html"><i class="fa fa-check"></i><b>10</b> Appendix</a>
<ul>
<li class="chapter" data-level="10.1" data-path="appendix.html"><a href="appendix.html#appendix-a-shell-scripts"><i class="fa fa-check"></i><b>10.1</b> Appendix A: Shell scripts</a>
<ul>
<li class="chapter" data-level="10.1.1" data-path="appendix.html"><a href="appendix.html#extract-ecmwf-forecasts"><i class="fa fa-check"></i><b>10.1.1</b> Extract ECMWF forecasts</a></li>
</ul></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Getting Started with the Climate Adaptation Data Platform</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="data-pipelines" class="section level1 hasAnchor" number="8">
<h1><span class="header-section-number">8</span> Data Pipelines<a href="data-pipelines.html#data-pipelines" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>The dependency graph representing the process for generating and disseminating
weather forecasts is shown in .
Starting with the , this task fetches baseline forecasts
from AWS.
The  task is responsible for this transformation.</p>
<p>Once the baseline forecast data are normalized,
the device observation normalization processes can be triggered.
The  and 

jobs are independent and can run concurrently.
Each device’s observation data is independent.
The data are partitioned by device, and are normalized per device.
Hence there will be a logical one-to-one correspondence between device and
normalization task.
All subsequent jobs are similarly on a per device basis.</p>
<p>The  and  jobs
depend on the air observations along with the baseline ECMWF forecasts.
Both jobs must finish before a summary  job can run.
This forecast represents a human-readable summary that can be displayed
on the webapp and also sent via email, SMS, or other medium.
The  step is responsible for
this final dissemination step.</p>
<p>The DAG in Figure  depicts the dependency graph of
field monitoring tasks.
The raw data normalization jobs , ,
and  can run concurrently.
These jobs extract the battery voltage, disk utilization, and
IP address from each device.
These jobs are cross-sectional and grab the latest time slice (or range)
for each device.
The data are aggregated by time slice in the 
task to produce cross sections.
The  processes the aggregated data
to generate alerts for devices with suspected issues.
Finally, the  task notifies the field operations
team to investigate the potential issues identified.</p>
<div id="ecmwf-baseline-forecasts" class="section level2 hasAnchor" number="8.1">
<h2><span class="header-section-number">8.1</span> ECMWF baseline forecasts<a href="data-pipelines.html#ecmwf-baseline-forecasts" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>ECMWF forecasts are updated every six hours.
Each forecast update comprises multiple individual step forecasts
in three hour incremements from 3 hours ahead up to 144 hours ahead.</p>
<div id="data-extraction" class="section level3 hasAnchor" number="8.1.1">
<h3><span class="header-section-number">8.1.1</span> Data extraction<a href="data-pipelines.html#data-extraction" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>To extract ECMWF archive data, use</p>
<pre><code>curl &#39;http://localhost:8080/ecmwf/extract?d=&lt;date&gt;</code></pre>
<p>where <code>&lt;date&gt;</code> is an ISO8601 date, such as <code>2024-02-09</code>.</p>
<p>Tasks:</p>
<ul>
<li>parallelize this job so each step forecast is downloaded independently to reduce the wall time of the extraction phase.</li>
</ul>
</div>
<div id="data-normalization" class="section level3 hasAnchor" number="8.1.2">
<h3><span class="header-section-number">8.1.2</span> Data normalization<a href="data-pipelines.html#data-normalization" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Each step forecast is about 27 MB in size, totaling 1.3 GB per forecast update.
These forecasts contain more data than we need.
A bash script normalizes this data into a more compact form
suitable to our needs.
This function takes the archive GRIB2 format and converts it to a smaller
GRIB2 file.
The final file size is 14 MB, which is 2 orders of magnitude smaller.</p>
<pre><code>curl &#39;http://localhost:8080/ecmwf/trim?d=&lt;date&gt;&amp;h=&lt;hour&gt;</code></pre>
<p>where <code>&lt;date&gt;</code> is an ISO8601 date, such as <code>2024-02-09</code>
and <code>&lt;hour&gt;</code> is one of <span class="math inline">\(\{0, 6, 12, 18\}\)</span>.</p>
</div>
</div>
<div id="sensor-normalization" class="section level2 hasAnchor" number="8.2">
<h2><span class="header-section-number">8.2</span> Sensor normalization<a href="data-pipelines.html#sensor-normalization" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Produce different datasets from the raw sensor data.
As new sensor data comes in, data can be appended to an existing data file.
Since the volume of data is small, each data file will contain 3 months of data.
The naming convention will be <code>&lt;key&gt;-&lt;year&gt;-&lt;quarter&gt;.csv</code>,
where the key is described below. The year is the 4 digit year, and the quarter
is simply an integer from 1-4.
For example,
the disk dataset for the first quarter of 2024 for a given device is
<code>disk-2024-1.csv</code>.</p>
<p>Note that timings are not exact. If a device is shut off and powered back on,
timing will fluctuate.</p>
<p>We may add more jobs as additional sensors become available.</p>
<p>Each normalization function takes a raw sensor dataset
and extracts rows that start with the given key.
Sensor readings are aggregated into 3 hour time periods, which correspond to
the forecast step period of the ECMWF forecasts.
This filtered dataset is then appended to the current quarterly dataset.</p>
<pre><code>curl -d &#39;device=&quot;ABC123&quot;&amp;year=2024&#39; \
  &#39;http://localhost:8004/ocpu/library/sensor.etl/R/do_air_temperature_pipeline&#39; </code></pre>
<p>The output is located in <code>private/sensor-norm</code>.
Note that this requires the <code>private/sensor-norm</code> directory to have global write
permissions. That is because the Apache server runs as user <code>www-data</code>.
The <code>Makefile</code> takes care of this detail.</p>
<p>The same operation works in the R console:</p>
<pre><code>&gt; library(sensor.etl)
&gt; do_air_temperature_pipeline(&#39;ABC123&#39;, 2024)</code></pre>
</div>
<div id="temperature-forecast" class="section level2 hasAnchor" number="8.3">
<h2><span class="header-section-number">8.3</span> Temperature forecast<a href="data-pipelines.html#temperature-forecast" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The temperature forecast uses a recursive least squares (RLS) algorithm
to integrate external forecast data with local sensor data.
It requires multiple days <span class="math inline">\(d\)</span> of forecasts as there is a burn-in period for the
algorithm.
To start, we will assume <span class="math inline">\(d=14\)</span> days of history for
the ECMWF forecast data and normalized sensor readings.</p>
<p>One complication is that the ECMWF forecast updates occur every six hours but
the forecast steps are every 3 hours.
To address this discrepancy and avoid data loss in the forecasts,
the model treats the forecast as a Martingale and copies forward an update
to create a 3 hour period update.</p>
</div>
<div id="precipitation-forecast" class="section level2 hasAnchor" number="8.4">
<h2><span class="header-section-number">8.4</span> Precipitation forecast<a href="data-pipelines.html#precipitation-forecast" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>This forecast will follow same approach as the temperature forecast.
Currently not implemented.</p>
</div>
<div id="disk-space-monitoring" class="section level2 hasAnchor" number="8.5">
<h2><span class="header-section-number">8.5</span> Disk space monitoring<a href="data-pipelines.html#disk-space-monitoring" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>If the onboard disk is full, no data can be collected.
The primary culprit will likely be log files.
Currently not implemented.</p>
</div>
<div id="battery-level-monitoring" class="section level2 hasAnchor" number="8.6">
<h2><span class="header-section-number">8.6</span> Battery level monitoring<a href="data-pipelines.html#battery-level-monitoring" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Devices with rapidly declining voltages need to be investigated by
field operations.
Currently not implemented.</p>
</div>
<div id="location-change" class="section level2 hasAnchor" number="8.7">
<h2><span class="header-section-number">8.7</span> Location change<a href="data-pipelines.html#location-change" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We want to look for changes in IP address that may indicate the device has
moved to a different location
Currently not implemented.</p>
</div>
<div id="device-availability" class="section level2 hasAnchor" number="8.8">
<h2><span class="header-section-number">8.8</span> Device availability<a href="data-pipelines.html#device-availability" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We can leverage the air observation data to determine whether the device is
operating normally. We use this dataset since it has a preset observation
frequency that is not user-modifiable. The frequency is once every 5 minutes.
Currently not implemented.</p>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="plugins.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="technical-details.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
